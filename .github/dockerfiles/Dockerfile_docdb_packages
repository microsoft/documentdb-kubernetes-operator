# Simplified DocumentDB Dockerfile using official packages
# This replaces the build-from-source approach with pre-built binary packages
# Benefits: 10-20x faster builds, smaller image, GPG-signed packages, easier maintenance
FROM mcr.microsoft.com/mirror/docker/library/debian:bookworm-slim

ARG PG_VERSION=16
ARG DocumentDB_VERSION=0.107-0

ENV PG_VERSION=${PG_VERSION}
ENV DocumentDB_VERSION=${DocumentDB_VERSION}
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV LANGUAGE=en_US
ENV PATH=$PATH:/usr/lib/postgresql/${PG_VERSION}/bin

# Install ICU 70 from Ubuntu 22.04 (DocumentDB packages are built against ICU 70)
# Debian Bookworm ships with ICU 72, which causes symbol compatibility issues
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -y --no-install-recommends wget ca-certificates \
    && mkdir -p /tmp/icu70 && cd /tmp/icu70 \
    && ARCH=$(dpkg --print-architecture) \
    # Use different mirror for arm64 vs amd64
    && if [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then \
        MIRROR="http://ports.ubuntu.com/ubuntu-ports"; \
       else \
        MIRROR="http://archive.ubuntu.com/ubuntu"; \
       fi \
    && wget -q ${MIRROR}/pool/main/i/icu/libicu70_70.1-2_${ARCH}.deb \
    && dpkg -i libicu70_70.1-2_${ARCH}.deb || apt-get install -f -y \
    && rm -rf /tmp/icu70 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install DocumentDB from official repository
# This single RUN command replaces 100+ lines of build-from-source steps
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -y --no-install-recommends \
        curl \
        gnupg2 \
        sudo \
        locales \
        ca-certificates \
        wget \
        unzip \
        lsb-release \
    # Add PostgreSQL official repository (pgdg) - required for PostgreSQL base packages
    && curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/postgresql-archive-keyring.gpg \
    && echo "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/postgresql-archive-keyring.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
    # Add DocumentDB official repository with GPG verification
    && curl -fsSL https://documentdb.io/documentdb-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/documentdb-archive-keyring.gpg \
    && echo "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/documentdb-archive-keyring.gpg] https://documentdb.io/deb stable main" > /etc/apt/sources.list.d/documentdb.list \
    # Update package lists from both repositories
    && apt-get update \
    # Install PostgreSQL with DocumentDB extensions
    # This includes: pg_documentdb_core, pg_documentdb, pg_documentdb_gw, and all dependencies
    # (Citus, RUM, libbson, PCRE2, Intel Math Lib, pgvector, PostGIS, etc.)
    && apt-get install -y --no-install-recommends postgresql-${PG_VERSION}-documentdb \
    # Setup locale (only en_US.UTF-8, not all locales)
    && localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 \
    # Remove unnecessary locale files
    && find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name 'en*' -exec rm -rf {} + \
    # Remove man pages and documentation to save space
    && rm -rf /usr/share/man/* \
    && rm -rf /usr/share/doc/* \
    # Remove unzip and wget after we're done with repository setup
    && apt-get remove -y --purge unzip lsb-release \
    && apt-get autoremove -y \
    # Cleanup to reduce image size
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# Create postgres user with proper permissions
# Note: PostgreSQL installation may have already created the postgres user
RUN usermod -aG sudo postgres || useradd -ms /bin/bash postgres -G sudo \
    && echo "%sudo ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/no-pass-ask \
    && cat /etc/sudoers | grep secure_path | sed "s/\:\/bin\:/\:\/bin\:\/usr\/lib\/postgresql\/$PG_VERSION\/bin\:/" >> /etc/sudoers.d/postgres_path \
    && mkdir -p /data /scripts

# Download DocumentDB scripts for server startup (minimal download)
RUN apt-get update && apt-get install -y --no-install-recommends wget unzip \
    && wget -q -P /tmp https://github.com/documentdb/documentdb/archive/refs/tags/v${DocumentDB_VERSION}.zip \
    && unzip -q /tmp/v${DocumentDB_VERSION}.zip -d /tmp/documentdb \
    && cp /tmp/documentdb/documentdb-${DocumentDB_VERSION}/scripts/start*.sh /scripts/ \
    && cp /tmp/documentdb/documentdb-${DocumentDB_VERSION}/scripts/stop*.sh /scripts/ 2>/dev/null || true \
    && cp /tmp/documentdb/documentdb-${DocumentDB_VERSION}/scripts/setup*.sh /scripts/ 2>/dev/null || true \
    && cp /tmp/documentdb/documentdb-${DocumentDB_VERSION}/scripts/utils.sh /scripts/ 2>/dev/null || true \
    && chmod +x /scripts/*.sh \
    && chown -R postgres:postgres /data /scripts \
    && apt-get remove -y --purge wget unzip \
    && apt-get autoremove -y && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/documentdb /tmp/v${DocumentDB_VERSION}.zip

# Set environment to ensure ICU 70 is used (DocumentDB was built against ICU 70)
# Detect architecture and set LD_PRELOAD accordingly
RUN ARCH=$(dpkg --print-architecture) \
    && if [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then \
        LIB_PATH="/usr/lib/aarch64-linux-gnu"; \
       else \
        LIB_PATH="/usr/lib/x86_64-linux-gnu"; \
       fi \
    && mkdir -p /etc/profile.d /home/postgres \
    && echo "export LD_PRELOAD=${LIB_PATH}/libicuuc.so.70:${LIB_PATH}/libicudata.so.70:${LIB_PATH}/libicui18n.so.70" > /etc/profile.d/icu70.sh \
    && echo "export LD_PRELOAD=${LIB_PATH}/libicuuc.so.70:${LIB_PATH}/libicudata.so.70:${LIB_PATH}/libicui18n.so.70" > /home/postgres/.bashrc \
    && chown -R postgres:postgres /home/postgres

# Health check to verify PostgreSQL is running
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD pg_isready -U postgres || exit 1

USER postgres
WORKDIR /home/postgres

# To run DocumentDB server:
# docker run -it <image> /bin/bash
# inside docker: `/scripts/start_oss_server.sh`
# 
# Alternative: Use official image directly:
# docker pull ghcr.io/documentdb/documentdb/documentdb-local:latest