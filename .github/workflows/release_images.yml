name: RELEASE - Promote Candidate Images and Publish Helm Chart

on:
  workflow_dispatch:
    inputs:
      candidate_version:
        description: 'Version of the build candidate to promote (will be tagged as {version})'
        required: true
        default: '0.1.1-test'
      version:
        description: 'Version to release (used for images and Helm chart)'
        required: true
        default: '0.1.1'
      run_tests:
        description: 'Run tests before releasing'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: write
  actions: read
  id-token: write

jobs:
  # Optional test jobs - run both E2E and integration tests in parallel if enabled
  test-e2e:
    name: E2E Test Images Before Release
    if: ${{ inputs.run_tests == true }}
    uses: ./.github/workflows/test-E2E.yml
    with:
      image_tag: ${{ inputs.candidate_version }}
    secrets: inherit

  test-integration:
    name: Integration Test Images Before Release
    if: ${{ inputs.run_tests == true }}
    uses: ./.github/workflows/test-integration.yml
    with:
      image_tag: ${{ inputs.candidate_version }}
    secrets: inherit

  test-backup-and-restore:
    name: Test Backup and Restore
    if: ${{ inputs.run_tests == true }}
    uses: ./.github/workflows/test-backup-and-restore.yml
    with:
      image_tag: ${{ inputs.candidate_version }}
    secrets: inherit

  copy-and-push-manifest:
    name: Release Images
    runs-on: ubuntu-latest
    needs: [test-e2e, test-integration, test-backup-and-restore]
    if: ${{ always() && (needs.test-e2e.result == 'success' || needs.test-e2e.result == 'skipped') && (needs.test-integration.result == 'success' || needs.test-integration.result == 'skipped') && (needs.test-backup-and-restore.result == 'success' || needs.test-backup-and-restore.result == 'skipped') }}
    strategy:
      matrix:
        image: [operator, sidecar, documentdb, gateway]
    steps:
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Retag existing manifest
        env:
          SOURCE_TAG: ${{ github.event.inputs.candidate_version }}
          TARGET_TAG: ${{ github.event.inputs.version }}
        run: |
          echo "Releasing ${{ matrix.image }} image from tag $SOURCE_TAG to $TARGET_TAG"
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository }}/${{ matrix.image }}:${{ env.TARGET_TAG }} \
            ghcr.io/${{ github.repository }}/${{ matrix.image }}:${{ env.SOURCE_TAG }}

  publish-helm-chart:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    needs: copy-and-push-manifest
    if: ${{ always() && needs.copy-and-push-manifest.result == 'success' }}
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      CHART_NAME: operator/documentdb-helm-chart
      GHCR_REPO: ghcr.io/${{ github.repository_owner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Update values.yaml with version tag
        run: |
          echo "Updating values.yaml with version tag: ${{ github.event.inputs.version }}"
          sed -i 's/tag: .*/tag: ${{ github.event.inputs.version }}/g' operator/documentdb-helm-chart/values.yaml
          echo "Updated values.yaml content:"
          cat operator/documentdb-helm-chart/values.yaml

      - name: Set chart version
        run: |
            echo "CHART_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
            echo "Using chart version: ${{ github.event.inputs.version }}"

      - name: Update Chart.yaml metadata
        run: |
          sed -i "s/^version: .*/version: ${CHART_VERSION}/" operator/documentdb-helm-chart/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"${CHART_VERSION}\"/" operator/documentdb-helm-chart/Chart.yaml

      - name: Package Helm chart
        run: |
          helm dependency update operator/documentdb-helm-chart
          helm package $CHART_NAME --version $CHART_VERSION

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Push Helm chart to GHCR
        run: |
          helm push /home/runner/work/documentdb-kubernetes-operator/documentdb-kubernetes-operator/documentdb-operator-${CHART_VERSION}.tgz oci://${GHCR_REPO}

      - name: Helm release summary
        run: |
          echo "## Helm Chart Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart Name**: \`$CHART_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$CHART_VERSION\` (unified for chart and images)" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Tag**: \`${{ github.event.inputs.candidate_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Tag**: \`${{ github.event.inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`$GHCR_REPO\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Images promoted from \`${{ github.event.inputs.candidate_version }}\` to \`${{ github.event.inputs.version }}\` and Helm chart published" >> $GITHUB_STEP_SUMMARY
  